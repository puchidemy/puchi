name: Infra Deploy

on:
  push:
    branches: [main, develop, "release/*"]
    paths:
      - "infra/**"
      - ".github/workflows/infra-only.yml"
  workflow_dispatch: {}

jobs:
  deploy-infra:
    runs-on: self-hosted
    env:
      KUBECONFIG: /home/anony/.kube/config.yaml
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup kubectl
        run: |
          if [ -f "$KUBECONFIG" ]; then echo "Using host kubeconfig at $KUBECONFIG"; else echo "KUBECONFIG not found at $KUBECONFIG" >&2; exit 1; fi

      - name: Apply base (namespaces, policies, quotas)
        run: |
          kubectl apply -k infra/k8s/base

      - name: Deploy APISIX from vendored manifests (no Helm)
        run: |
          if [ ! -f infra/k8s/platform/apisix/rendered.yaml ]; then
            echo "Missing infra/k8s/platform/apisix/rendered.yaml. Please vendor manifests via 'helm template' locally and commit." >&2
            exit 1
          fi
          kubectl get ns apisix >/dev/null 2>&1 || kubectl create ns apisix
          kubectl apply -f infra/k8s/platform/apisix/rendered.yaml

      - name: Apply platform (cloudflared etc.)
        env:
          TUNNEL_TOKEN: ${{ secrets.K8S_CLOUDFLARED_TUNNEL_TOKEN }}
        run: |
          kubectl apply -k infra/k8s/base
          kubectl get ns platform >/dev/null 2>&1 || kubectl create ns platform
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: cloudflared-secret
            namespace: platform
          type: Opaque
          stringData:
            TUNNEL_TOKEN: "${TUNNEL_TOKEN}"
          EOF
          kubectl apply -k infra/k8s/platform
          
